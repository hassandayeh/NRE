// prisma/schema.prisma
// Base: Orgs, Users, Roles (slots 1..10), Bookings, Modes & Access (additive-only)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/* =========================
   Enums
   ========================= */
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum AppearanceType {
  IN_PERSON
  ONLINE
  PHONE
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

/* =========================
   Tenancy & Users
   ========================= */
model Organization {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(200)

  // Access control
  orgRoles   OrgRole[]
  userRoles  UserRole[]

  // Modes & access (additive)
  modes              OrganizationMode[]
  modePresets        OrganizationModePreset[]
  accessPresets      OrganizationAccessPreset[]

  // Domain
  bookings  Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique @db.VarChar(320)
  hashedPassword   String   @db.VarChar(255)

  displayName      String?  @db.VarChar(200)
  avatarUrl        String?  @db.Text
  bio              String?  @db.Text

  languages        String[] @default([])
  tags             String[] @default([])
  supportsOnline   Boolean  @default(false)
  supportsInPerson Boolean  @default(false)
  city             String?  @db.VarChar(200)
  countryCode      String?  @db.VarChar(2)
  timeZone         String?  @db.VarChar(64)

  userRoles        UserRole[]
  bookingParticipants BookingParticipant[]
  notes               BookingNote[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([displayName])
  @@index([countryCode])
}

/* =========================
   Access Control (Roles 1â€“10)
   ========================= */
model PermissionKey {
  id            String   @id @default(cuid())
  key           String   @unique @db.VarChar(120)
  description   String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  templateLinks RoleTemplatePermission[]
  orgLinks      OrgRolePermission[]
}

model RoleTemplate {
  id                 String   @id @default(cuid())
  slot               Int      @unique
  defaultLabel       String   @db.VarChar(100)
  isActiveByDefault  Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  permissions        RoleTemplatePermission[]
}

model RoleTemplatePermission {
  roleTemplateId  String
  permissionKeyId String
  roleTemplate  RoleTemplate  @relation(fields: [roleTemplateId], references: [id], onDelete: Cascade)
  permissionKey PermissionKey @relation(fields: [permissionKeyId], references: [id], onDelete: Cascade)
  @@id([roleTemplateId, permissionKeyId])
}

model OrgRole {
  id        String   @id @default(cuid())
  orgId     String
  slot      Int
  label     String   @db.VarChar(100)
  isActive  Boolean  @default(false)

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  permissions OrgRolePermission[]
  assignments UserRole[] @relation("OrgRoleAssignments")

  @@unique([orgId, slot])
  @@index([orgId])
}

model OrgRolePermission {
  orgRoleId       String
  permissionKeyId String
  allowed         Boolean @default(true)

  orgRole       OrgRole       @relation(fields: [orgRoleId], references: [id], onDelete: Cascade)
  permissionKey PermissionKey @relation(fields: [permissionKeyId], references: [id], onDelete: Cascade)

  @@id([orgRoleId, permissionKeyId])
}

model UserRole {
  userId     String
  orgId      String
  slot       Int
  assignedAt DateTime @default(now())
  orgManaged Boolean  @default(false)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  orgRole OrgRole @relation("OrgRoleAssignments", fields: [orgId, slot], references: [orgId, slot], onDelete: Cascade)

  @@id([userId, orgId])
  @@index([orgId, slot])
}

/* =========================
   Modes (per org) + Presets & Access (additive)
   ========================= */

/** OrganizationMode
 * API upserts by { orgId_slot: { orgId, slot } }
 * Field is named `active` for Prisma client, but mapped to existing DB column `isActive`.
 */
model OrganizationMode {
  id        String   @id @default(cuid())
  orgId     String
  slot      Int
  label     String   @db.VarChar(120)
  active    Boolean  @map("isActive") @default(false) // <-- no drop/rename in DB

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, slot])
  @@index([orgId])
}

/** Optional curated mode label per org+slot */
model OrganizationModePreset {
  id        String   @id @default(cuid())
  orgId     String
  slot      Int
  label     String   @db.VarChar(120)
  active    Boolean  @default(false)

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, slot])
  @@index([orgId])
}

/** Catalog of access fields (keys) that can be toggled per mode */
model OrganizationAccessField {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(120)
  label       String   @db.VarChar(200)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  presets     OrganizationAccessPreset[]
}

/** Per-org+mode toggle for a field (allowed/denied) */
model OrganizationAccessPreset {
  id        String   @id @default(cuid())
  orgId     String
  modeSlot  Int
  fieldId   String
  allowed   Boolean  @default(true)

  organization Organization           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  field        OrganizationAccessField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, modeSlot, fieldId])
  @@index([orgId])
}

/* =========================
   Bookings & Participation
   ========================= */
model Booking {
  id            String   @id @default(cuid())
  orgId         String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  subject       String   @db.VarChar(300)
  status        BookingStatus @default(PENDING)
  startAt       DateTime
  durationMins  Int

  appearanceType  AppearanceType?
  locationUrl     String?
  locationName    String? @db.VarChar(300)
  locationAddress String?
  dialInfo        String?

  participants  BookingParticipant[]
  notes         BookingNote[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orgId])
  @@index([startAt])
}

model BookingParticipant {
  id         String   @id @default(cuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  roleSlot   Int
  roleLabelSnapshot String? @db.VarChar(100)

  inviteStatus  InviteStatus @default(PENDING)

  invitedByUserId String?
  invitedAt       DateTime?
  respondedAt     DateTime?

  notes       String? @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([bookingId, userId])
  @@index([bookingId])
  @@index([roleSlot])
  @@index([userId, inviteStatus])
}

model BookingNote {
  id        String   @id @default(cuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  body      String   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId, createdAt])
}
